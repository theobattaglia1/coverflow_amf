<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AMF ADMIN ‚Äî EDITORIAL INTERFACE</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="icon" type="image/x-icon" href="/favicon.svg">
  <link rel="stylesheet" href="admin-swiss.css">
  <link rel="stylesheet" href="https://unpkg.com/cropperjs@1.6.1/dist/cropper.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  <script src="https://unpkg.com/cropperjs@1.6.1/dist/cropper.min.js"></script>
  
  <style>
    /* Image scaling fixes */
    .cover-image-wrapper {
      width: 100%;
      aspect-ratio: 1;
      overflow: hidden;
      position: relative;
      background: #f0f0f0;
    }
    
    .cover-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .recent-cover .cover-image-wrapper {
      aspect-ratio: 1;
    }
    
    /* Drag and drop styles */
    .sortable-ghost {
      opacity: 0.4;
    }
    
    .sortable-chosen {
      transform: scale(1.02);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    }
    
    .sortable-drag {
      opacity: 1 !important;
      cursor: grabbing !important;
    }
    
    /* Cursor hint for draggable items */
    .covers-grid .cover-image-wrapper {
      cursor: grab;
    }
    
    .covers-grid .cover-image-wrapper:active {
      cursor: grabbing;
    }
    
    /* Disable drag cursor in batch mode */
    .batch-active .cover-image-wrapper {
      cursor: pointer !important;
    }
    
    /* Smaller grid items */
    .covers-grid {
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)) !important;
      gap: 16px !important;
    }
    
    /* Adjust text size for smaller covers */
    .cover-info h3 {
      font-size: 0.85rem;
      line-height: 1.2;
    }
    
    .cover-info p {
      font-size: 0.75rem;
    }
    
    .category-tag {
      font-size: 0.7rem;
      padding: 2px 6px;
    }
    
    /* Smaller overlay buttons */
    .cover-overlay .cover-actions button {
      font-size: 0.75rem;
      padding: 4px 8px;
    }
  </style>
</head>
<body>

<div class="admin-wrapper">
  <!-- Fixed Header: Minimal, typography-focused -->
  <header class="admin-header">
    <div class="container">
      <div class="admin-logo">AMF://ADMIN</div>
      
      <!-- Global Search Bar -->
      <div class="global-search-container">
        <input type="text" 
               class="global-search-input" 
               id="globalSearch" 
               placeholder="SEARCH ACROSS ALL SECTIONS..."
               autocomplete="off">
        <div class="global-search-results" id="globalSearchResults" style="display: none;">
          <!-- Search results will be populated here -->
        </div>
      </div>
      
      <div class="header-actions">
        <div class="user-info">
          <span id="username">LOADING...</span>
          <span class="user-role" id="userRole">‚Äî</span>
          <button class="btn btn-danger" onclick="logout()">EXIT</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content: Generous spacing, editorial structure -->
  <main class="admin-main">
    <div class="container">
      <div class="admin-layout">
        <!-- Sidebar Navigation -->
        <aside class="admin-sidebar">
          <div class="sidebar-group">
            <div class="sidebar-label">CONTENT</div>
            <nav class="admin-nav">
              <a href="#covers" class="active">COVERS</a>
            </nav>
          </div>
          
          <div class="sidebar-group">
            <div class="sidebar-label">LIBRARY</div>
            <nav class="admin-nav">
              <a href="#assets">ASSETS</a>
              <a href="#audio">AUDIO</a>
            </nav>
          </div>
          
          <div class="sidebar-group">
            <div class="sidebar-label">SYSTEM</div>
            <nav class="admin-nav">
              <a href="#users">USERS</a>
            </nav>
          </div>
        </aside>
        
        <!-- Primary content area -->
        <div class="admin-content">
      
      <!-- 01 ‚Äî COVERS -->
      <section class="section" id="coversSection">
        <div class="section-marker">
          <span class="section-number">01 ‚Äî</span>
          <h1 class="section-title" data-text="COVERS">COVERS</h1>
        </div>

        <!-- Progressive Disclosure: Recently Edited Section -->
        <div class="recently-edited-section" id="recentlyEditedSection">
          <div class="subsection-header">
            <h3 class="subsection-title">RECENTLY EDITED</h3>
            <button class="btn-text" onclick="toggleFullCoversView()">VIEW ALL ‚Üí</button>
          </div>
          <div class="recent-covers-grid" id="recentCoversContainer">
            <!-- Recent covers will be dynamically loaded -->
          </div>
        </div>

        <!-- Enhanced Controls -->
        <div class="covers-controls" id="coversControls" style="display: none;">
          <!-- View Mode Toggles -->
          <div class="view-mode-toggles">
            <button class="view-toggle active" data-view="grid" onclick="setViewMode('grid')" title="Grid View">
              <span class="view-icon">‚äû</span>
            </button>
            <button class="view-toggle" data-view="list" onclick="setViewMode('list')" title="List View">
              <span class="view-icon">‚ñ°</span>
            </button>
            <button class="view-toggle" data-view="coverflow" onclick="setViewMode('coverflow')" title="Coverflow View">
              <span class="view-icon">‚âã</span>
            </button>
          </div>

          <!-- Enhanced Search and Filters -->
          <div class="search-filter-container">
            <input type="text" 
                   class="search-input" 
                   id="coverSearch" 
                   placeholder="SEARCH BY TITLE, ARTIST, OR CATEGORY..."
                   autocomplete="off">
            
            <div class="filter-controls">
              <select class="filter-select" id="categoryFilter">
                <option value="">ALL CATEGORIES</option>
                <option value="artist">ARTIST</option>
                <option value="songwriter">SONGWRITER</option>
                <option value="producer">PRODUCER</option>
                <option value="about us">ABOUT US</option>
              </select>
              
              <select class="filter-select" id="sortOrder">
                <option value="date">NEWEST FIRST</option>
                <option value="index">MANUAL ORDER</option>
                <option value="title">TITLE A-Z</option>
                <option value="title-desc">TITLE Z-A</option>
                <option value="date-desc">OLDEST FIRST</option>
              </select>
              
              <button class="btn btn-sm" onclick="toggleAdvancedFilters('covers')" id="advancedFiltersToggle">
                ADVANCED FILTERS
              </button>
            </div>
          </div>
          
          <!-- Advanced Filters Section -->
          <div class="advanced-filters" id="advancedFilters" style="display: none;">
            <div class="advanced-filters-header">
              <h4>ADVANCED FILTERS</h4>
            </div>
            
            <div class="advanced-filters-grid">
              <div class="filter-group">
                <label class="filter-label">DATE RANGE</label>
                <div class="date-range-inputs">
                  <input type="date" class="date-input" id="dateFrom" placeholder="FROM">
                  <span class="date-separator">TO</span>
                  <input type="date" class="date-input" id="dateTo" placeholder="TO">
                </div>
              </div>
              
              <div class="filter-group">
                <label class="filter-label">TAGS</label>
                <input type="text" class="search-input" id="tagsFilter" placeholder="ENTER TAGS SEPARATED BY COMMAS...">
              </div>
              
              <div class="filter-group">
                <label class="filter-label">QUICK FILTERS</label>
                <div class="quick-filters">
                  <button class="quick-filter-btn" onclick="applyQuickFilter('recent')" data-filter="recent">
                    LAST 7 DAYS
                  </button>
                  <button class="quick-filter-btn" onclick="applyQuickFilter('month')" data-filter="month">
                    LAST MONTH
                  </button>
                  <button class="quick-filter-btn" onclick="applyQuickFilter('favorites')" data-filter="favorites">
                    FAVORITES
                  </button>
                  <button class="quick-filter-btn" onclick="clearAllFilters()" data-filter="clear">
                    CLEAR ALL
                  </button>
                </div>
              </div>
            </div>

          <!-- Batch Operations Bar -->
          <div class="batch-operations" id="batchOperations" style="display: none;">
            <div class="batch-info">
              <span id="selectedCount">0</span> SELECTED
            </div>
            <div class="batch-actions">
              <button class="btn btn-sm" onclick="selectAllCovers()">SELECT ALL</button>
              <button class="btn btn-sm" onclick="clearSelection()">CLEAR</button>
              <button class="btn btn-sm" onclick="exportSelected()">EXPORT</button>
              <button class="btn btn-danger btn-sm" onclick="deleteSelected()">DELETE</button>
            </div>
          </div>
        </div>
        
        <!-- Main Covers Container -->
        <div class="covers-main-container" id="coversMainContainer" style="display: none;">
          <!-- Different view modes will be rendered here -->
          <div class="covers-container covers-view-grid" id="coversContainer">
            <!-- Covers will be dynamically loaded -->
          </div>
          
          <div class="covers-container covers-view-list" id="coversListContainer" style="display: none;">
            <!-- List view will be rendered here -->
          </div>
          
          <div class="covers-container covers-view-coverflow" id="coversCoverflowContainer" style="display: none;">
            <!-- Coverflow view will be rendered here -->
          </div>

          <!-- Pagination Controls -->
          <div class="pagination-controls" id="paginationControls" style="display: none;">
            <button class="btn btn-sm" id="prevPage" onclick="changePage(-1)">‚Üê PREV</button>
            <span class="page-info" id="pageInfo">1 / 1</span>
            <button class="btn btn-sm" id="nextPage" onclick="changePage(1)">NEXT ‚Üí</button>
          </div>
        </div>
        
        <!-- Dropzone: Minimal design -->
        <div class="dropzone" id="coverDropzone">
          <span class="dropzone-text">DROP IMAGE TO CREATE NEW COVER</span>
        </div>
        
        <!-- Action buttons: Brutalist elegance -->
        <div class="covers-actions">
          <button class="btn btn-primary" onclick="saveChanges()">SAVE CHANGES</button>
          <button class="btn" onclick="toggleBatchMode()" id="batchModeBtn">BATCH MODE</button>
          <button class="btn" onclick="exportCovers()" style="display: none;" id="exportBtn">EXPORT SELECTED</button>
          <button class="btn btn-danger" onclick="deleteSelected()" style="display: none;" id="deleteBtn">DELETE SELECTED</button>
          <button class="btn" onclick="pushLive()">PUSH LIVE</button>
        </div>
      </section>

      <!-- 02 ‚Äî ASSETS -->
      <section class="section" id="assetsSection">
        <div class="section-marker">
          <span class="section-number">02 ‚Äî</span>
          <h1 class="section-title" data-text="ASSETS">ASSETS</h1>
        </div>
        
        <!-- Enhanced Asset Controls -->
        <div class="asset-controls">
          <!-- Search and Filter Row -->
          <div class="asset-search-filter-container">
            <input type="text" 
                   class="search-input" 
                   id="assetSearch" 
                   placeholder="SEARCH ASSETS BY NAME, TYPE, OR FOLDER..."
                   autocomplete="off">
            
            <div class="asset-filter-controls">
              <select class="filter-select" id="assetTypeFilter">
                <option value="">ALL TYPES</option>
                <option value="image">IMAGES</option>
                <option value="video">VIDEOS</option>
                <option value="document">DOCUMENTS</option>
              </select>
              
              <select class="filter-select" id="assetSortOrder">
                <option value="date-desc">NEWEST FIRST</option>
                <option value="date-asc">OLDEST FIRST</option>
                <option value="name-asc">NAME A-Z</option>
                <option value="name-desc">NAME Z-A</option>
                <option value="size-desc">LARGEST FIRST</option>
                <option value="size-asc">SMALLEST FIRST</option>
              </select>
              
              <select class="filter-select" id="assetFolderFilter">
                <option value="">ALL FOLDERS</option>
                <!-- Folders will be populated dynamically -->
              </select>
            </div>
          </div>
          
          <!-- View Mode and Actions Row -->
          <div class="asset-view-actions-row">
            <div class="asset-view-modes">
              <button class="view-mode-btn active" data-view="grid" onclick="setAssetViewMode('grid')" title="Grid View">
                <span class="view-icon">‚äû</span>
              </button>
              <button class="view-mode-btn" data-view="list" onclick="setAssetViewMode('list')" title="List View">
                <span class="view-icon">‚ñ°</span>
              </button>
              <button class="view-mode-btn" data-view="coverflow" onclick="setAssetViewMode('coverflow')" title="Coverflow View">
                <span class="view-icon">‚âã</span>
              </button>
            </div>
            
            <div class="asset-actions">
              <button class="btn btn-sm" onclick="toggleAssetMultiSelectMode()">
                <span id="assetMultiSelectToggleText">MULTI-SELECT</span>
              </button>
              <button class="btn btn-sm" onclick="refreshAssets()">REFRESH</button>
              <span class="asset-count-indicator" id="assetCountIndicator">0 ASSETS</span>
            </div>
          </div>
        </div>
        
        <div class="asset-browser">
          <!-- Folder navigation -->
          <div class="folder-panel">
            <button class="btn btn-primary" onclick="createNewFolder()" style="width: 100%; margin-bottom: var(--space-lg);">
              + NEW FOLDER
            </button>
            <ul class="folder-list" id="folderTree">
              <!-- Folders will be dynamically loaded -->
            </ul>
          </div>
          
          <!-- Asset grid -->
          <div class="asset-content">
            <div id="currentFolderIndicator" style="font-family: var(--font-mono); font-size: 0.9em; margin-bottom: 8px; color: #888;">
              Current Folder: ROOT
            </div>
            <div class="dropzone" id="assetDropzone">
              <span class="dropzone-text">DROP IMAGES HERE</span>
            </div>
            
            <div class="asset-grid" id="assetsContainer">
              <!-- Assets will be dynamically loaded -->
            </div>

            <div class="pagination-controls" id="assetPaginationControls" style="display: none; margin-top: var(--space-lg);">
              <button class="btn btn-sm" id="assetPrevPage" onclick="changeAssetPage(-1)">‚Üê PREV</button>
              <span class="page-info" id="assetPageInfo">1 / 1</span>
              <button class="btn btn-sm" id="assetNextPage" onclick="changeAssetPage(1)">NEXT ‚Üí</button>
            </div>
          </div>
        </div>
        
        <!-- Asset batch operations toolbar -->
        <div class="batch-toolbar" id="assetBatchToolbar" style="display: none;">
          <div class="batch-info">
            <span id="assetSelectedCount">0</span> ASSETS SELECTED
          </div>
          <div class="batch-actions">
            <button class="btn btn-sm" onclick="selectAllAssetsInFolder()">SELECT ALL</button>
            <button class="btn btn-sm" onclick="copySelectedAssetLinks()">COPY LINKS</button>
            <button class="btn btn-sm" onclick="moveSelectedAssets()">MOVE</button>
            <button class="btn btn-sm" onclick="downloadSelectedAssets()">DOWNLOAD</button>
            <button class="btn btn-danger btn-sm" onclick="deleteSelectedAssets()">DELETE</button>
            <button class="btn btn-sm" onclick="deselectAllAssets()">DESELECT ALL</button>
          </div>
        </div>
      </section>

      <!-- 03 ‚Äî AUDIO -->
      <section class="section" id="audioSection">
        <div class="section-marker">
          <span class="section-number">03 ‚Äî</span>
          <h1 class="section-title" data-text="AUDIO">AUDIO</h1>
        </div>
        
        <!-- Enhanced Audio Controls -->
        <div class="audio-controls">
          <!-- Search and Filter Row -->
          <div class="audio-search-filter-container">
            <input type="text" 
                   class="search-input" 
                   id="audioSearch" 
                   placeholder="SEARCH AUDIO BY NAME, ARTIST, OR FOLDER..."
                   autocomplete="off">
            
            <div class="audio-filter-controls">
              <select class="filter-select" id="audioTypeFilter">
                <option value="">ALL FORMATS</option>
                <option value="mp3">MP3</option>
                <option value="wav">WAV</option>
                <option value="flac">FLAC</option>
                <option value="m4a">M4A</option>
              </select>
              
              <select class="filter-select" id="audioSortOrder">
                <option value="date-desc">NEWEST FIRST</option>
                <option value="date-asc">OLDEST FIRST</option>
                <option value="name-asc">NAME A-Z</option>
                <option value="name-desc">NAME Z-A</option>
                <option value="duration-desc">LONGEST FIRST</option>
                <option value="duration-asc">SHORTEST FIRST</option>
              </select>
              
              <select class="filter-select" id="audioFolderFilter">
                <option value="">ALL FOLDERS</option>
                <!-- Folders will be populated dynamically -->
              </select>
            </div>
          </div>
          
          <!-- View Mode and Actions Row -->
          <div class="audio-view-actions-row">
            <div class="audio-view-modes">
              <button class="view-mode-btn active" data-view="list" onclick="setAudioViewMode('list')" title="List View">
                <span class="view-icon">‚ñ°</span>
              </button>
              <button class="view-mode-btn" data-view="grid" onclick="setAudioViewMode('grid')" title="Grid View">
                <span class="view-icon">‚äû</span>
              </button>
              <button class="view-mode-btn" data-view="player" onclick="setAudioViewMode('player')" title="Player View">
                <span class="view-icon">‚ô™</span>
              </button>
            </div>
            
            <div class="audio-actions">
              <button class="btn btn-sm" onclick="toggleAudioMultiSelectMode()">
                <span id="audioMultiSelectToggleText">MULTI-SELECT</span>
              </button>
              <button class="btn btn-sm" onclick="refreshAudio()">REFRESH</button>
              <span class="audio-count-indicator" id="audioCountIndicator">0 TRACKS</span>
            </div>
          </div>
        </div>
        
        <div class="audio-browser">
          <!-- Audio folder navigation -->
          <div class="folder-panel">
            <button class="btn btn-primary" onclick="createNewAudioFolder()" style="width: 100%; margin-bottom: var(--space-lg);">
              + NEW FOLDER
            </button>
            <ul class="folder-list" id="audioFolderTree">
              <!-- Audio folders will be dynamically loaded -->
            </ul>
          </div>
          
          <!-- Audio content -->
          <div class="audio-content">
            <div class="audio-artist-hubs" id="audioArtistHubs">
              <!-- Artist hubs will be dynamically loaded -->
            </div>
            <div class="dropzone" id="audioDropzone">
              <span class="dropzone-text">DROP AUDIO FILES HERE</span>
            </div>
            
            <div class="audio-grid" id="audioContainer">
              <!-- Audio files will be dynamically loaded -->
            </div>
          </div>
        </div>
        
        <!-- Audio batch operations toolbar -->
        <div class="batch-toolbar" id="audioBatchToolbar" style="display: none;">
          <div class="batch-info">
            <span id="audioSelectedCount">0</span> AUDIO FILES SELECTED
          </div>
          <div class="batch-actions">
            <button class="btn btn-sm" onclick="moveSelectedAudio()">MOVE</button>
            <button class="btn btn-sm" onclick="downloadSelectedAudio()">DOWNLOAD</button>
            <button class="btn btn-danger btn-sm" onclick="deleteSelectedAudio()">DELETE</button>
            <button class="btn btn-sm" onclick="deselectAllAudio()">DESELECT ALL</button>
          </div>
        </div>
      </section>

      <!-- 04 ‚Äî USERS -->
      <section class="section" id="usersSection" style="display: none;">
        <div class="section-marker">
          <span class="section-number">04 ‚Äî</span>
          <h1 class="section-title" data-text="USERS">USERS</h1>
        </div>
        
        <div class="grid">
          <div style="grid-column: span 6;">
            <h3>CURRENT USERS</h3>
            <div id="usersList" style="margin-top: var(--space-lg);">
              <!-- Users will be dynamically loaded -->
            </div>
          </div>
          
          <div style="grid-column: span 6;">
            <h3>ADD NEW USER</h3>
            <form id="addUserForm" onsubmit="addUser(event)" style="margin-top: var(--space-lg);">
              <div class="form-group">
                <label class="form-label">USERNAME</label>
                <input type="text" class="form-input" name="username" autocomplete="username" required>
              </div>
              
              <div class="form-group">
                <label class="form-label">PASSWORD</label>
                <input type="password" class="form-input" name="password" autocomplete="new-password" required>
              </div>
              
              <div class="form-group">
                <label class="form-label">ROLE</label>
                <select class="form-select" name="role" required>
                  <option value="viewer">VIEWER</option>
                  <option value="editor">EDITOR</option>
                  <option value="admin">ADMIN</option>
                </select>
              </div>
              
              <button type="submit" class="btn btn-primary">CREATE USER</button>
            </form>
          </div>
        </div>
      </section>
        </div> <!-- end admin-content -->
      </div> <!-- end admin-layout -->
    
    </div>
  </main>
</div>

<!-- Side panel for cover editing (replaces centered modal) -->
<div class="modal modal-side" id="coverModal">
  <div class="modal-content modal-content-side">
    <div class="modal-header">
      <h2 class="modal-title">EDIT COVER</h2>
      <button class="modal-close" onclick="closeModal()">CLOSE</button>
    </div>
    <div id="modalBody">
      <!-- Panel content will be dynamically loaded -->
    </div>
  </div>
</div>

<!-- Toast notifications: Editorial announcement -->
<div id="toast" class="toast"></div>

<!-- Loading indicator -->
<div class="loading" id="loading" style="display: none;">LOADING...</div>

<script>
// Initialize smooth scrolling for navigation
document.querySelectorAll('.admin-nav a[href^="#"]').forEach(anchor => {
  anchor.addEventListener('click', function (e) {
    e.preventDefault();
    const href = this.getAttribute('href'); // e.g. "#covers"
    const baseId = href.replace('#', '');   // "covers"
    const sectionId = `${baseId}Section`;   // "coversSection"
    const target = document.getElementById(sectionId);
    if (target) {
      target.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    // Update active state
    document.querySelectorAll('.admin-nav a').forEach(a => a.classList.remove('active'));
    this.classList.add('active');
  });
});

// Note: Main initialization now lives in modular JS files

// Logout function
function logout() {
  fetch('/api/logout', { method: 'POST' })
    .then(() => window.location.href = '/login.html');
}

// Toast notification
function showToast(message, duration = 5000) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.classList.add('show');
  
  setTimeout(() => {
    toast.classList.remove('show');
  }, duration);
}

// Modal functions
function openModal() {
  document.getElementById('coverModal').classList.add('active');
}

function closeModal() {
  document.getElementById('coverModal').classList.remove('active');
}

// Close modal on background click
document.getElementById('coverModal').addEventListener('click', (e) => {
  if (e.target === e.currentTarget) {
    closeModal();
  }
});

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeModal();
  }
  
  // Cmd/Ctrl + S to save
  if ((e.metaKey || e.ctrlKey) && e.key === 's') {
    e.preventDefault();
    saveChanges();
  }
});
</script>

<!-- Load modular admin scripts -->
<script src="js/shared-admin.js"></script>
<script src="js/covers-admin.js"></script>
<script src="js/assets-admin.js"></script>
<script src="js/audio-admin.js"></script>
<script src="js/users-admin.js"></script>
<script src="js/main-admin.js"></script>

<!-- Initialize all modules -->
<script>
// Initialize admin modules after DOM is ready
async function initializeAdminModules() {
  console.log('üöÄ Initializing Admin Dashboard...');
  
  // Check authentication first
  const authenticated = await checkAuth();
  if (!authenticated) return;
  
  // Initialize modules
  await initializeCovers();
  await initializeAssets();
  await initializeAudio();
  await initializeUsers();
  
  // Initialize main admin functionality
  initializeMainAdmin();
  
  // Setup global search
  setupGlobalSearch();
  
  // Make critical functions globally available
  window.saveChanges = window.saveChanges || coversModule.saveChanges;
  window.pushLive = window.pushLive || coversModule.pushLive;
  window.editCover = window.editCover || coversModule.editCover;
  
  console.log('‚úÖ Admin Dashboard Ready');
}

// Global search implementation
function setupGlobalSearch() {
  const globalSearchInput = document.getElementById('globalSearch');
  const globalSearchResults = document.getElementById('globalSearchResults');
  
  if (!globalSearchInput || !globalSearchResults) return;
  
  let searchTimeout;
  
  globalSearchInput.addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    const query = e.target.value.trim();
    
    if (query.length === 0) {
      globalSearchResults.style.display = 'none';
      return;
    }
    
    searchTimeout = setTimeout(() => {
      performGlobalSearch(query);
    }, 300);
  });
  
  document.addEventListener('click', (e) => {
    if (!globalSearchInput.contains(e.target) && !globalSearchResults.contains(e.target)) {
      globalSearchResults.style.display = 'none';
    }
  });
  
  globalSearchInput.addEventListener('focus', () => {
    if (globalSearchInput.value.trim().length > 0) {
      globalSearchResults.style.display = 'block';
    }
  });
}

function performGlobalSearch(query) {
  const searchQuery = query.toLowerCase();
  const results = {
    covers: searchCovers(searchQuery),
    assets: searchAssets(searchQuery),
    audio: searchAudio(searchQuery)
  };
  
  displayGlobalSearchResults(results, query);
}

function searchCovers(query) {
  if (!window.covers || !Array.isArray(window.covers)) return [];
  
  return window.covers.filter(cover => 
    (cover.albumTitle && cover.albumTitle.toLowerCase().includes(query)) ||
    (cover.coverLabel && cover.coverLabel.toLowerCase().includes(query)) ||
    (cover.category && cover.category.some(cat => cat.toLowerCase().includes(query)))
  ).slice(0, 5);
}

function searchAssets(query) {
  if (!window.assets || !window.assets.images) return [];
  
  return window.assets.images.filter(asset => 
    (asset.name && asset.name.toLowerCase().includes(query)) ||
    (asset.url && asset.url.toLowerCase().includes(query))
  ).slice(0, 5);
}

function displayGlobalSearchResults(results, query) {
  const globalSearchResults = document.getElementById('globalSearchResults');
  if (!globalSearchResults) return;
  
  const totalResults = results.covers.length + results.assets.length + results.audio.length;
  
  if (totalResults === 0) {
    globalSearchResults.innerHTML = '<div class="global-search-empty">No results found</div>';
    globalSearchResults.style.display = 'block';
    return;
  }
  
  let html = '';
  
  if (results.covers.length > 0) {
    html += '<div class="global-search-section"><h4>COVERS</h4>';
    results.covers.forEach(cover => {
      html += `<div class="global-search-item" onclick="editCover(covers.find(c => c.id === '${cover.id}'))">
        <strong>${cover.albumTitle || 'Untitled'}</strong> - ${cover.coverLabel || ''}
      </div>`;
    });
    html += '</div>';
  }
  
  if (results.assets.length > 0) {
    html += '<div class="global-search-section"><h4>ASSETS</h4>';
    results.assets.forEach(asset => {
      html += `<div class="global-search-item" onclick="copyAssetUrl('${asset.url}')">
        ${asset.name || 'Unnamed Asset'}
      </div>`;
    });
    html += '</div>';
  }
  
  if (results.audio.length > 0) {
    html += '<div class="global-search-section"><h4>AUDIO</h4>';
    results.audio.forEach(audio => {
      html += `<div class="global-search-item" onclick="copyAudioUrl('${audio.url}')">
        ${audio.filename || audio.name || 'Unnamed Audio'}
      </div>`;
    });
    html += '</div>';
  }
  
  globalSearchResults.innerHTML = html;
  globalSearchResults.style.display = 'block';
}

// Start initialization when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeAdminModules);
} else {
  initializeAdminModules();
}
</script>

</body>
</html> 